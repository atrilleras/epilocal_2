---
title: 'Reporte: exploración de la librería "Epidemia"'
date: "23/7/2020"
output: html_document
---

A continuación se presentan algunos resultados para la Ciudad de Bogotá, en estos se presenta la estimación del número reproductivo efectivo R(t) a partir de las herramientas ofrecidas por la librería  "epidemia".

## Simulación a partir del número de muertes en Bogotá en relación con una caminata aletoría y si intercepto en el predictor lineal.

```{r, message=FALSE, echo=FALSE, warning=FALSE}

library (RCurl)
library(squire)
library(patchwork)
library(ggplot2)
library(dplyr)
library(epitrix)
library(readr)
library(incidence)
library(readxl)
library(EpiEstim)
library(openxlsx)
library(gridExtra)
library(lubridate)
library(stringr)
library(epidemia)
library(gridExtra)
rm(list=ls())
source("funs_z.R")

#____ DATASET E INCIDENCIA
cases <- read_csv("data/Casos_positivos_de_COVID-19_21_07_20.csv")
datos <- read_csv("data/Casos_positivos_de_COVID-19_21_07_20.csv")
names(cases) <- epitrix::clean_labels(names(cases))
cases$departamento_o_distrito <- epitrix::clean_labels(cases$departamento_o_distrito)
unique(cases$departamento_o_distrito)
bog_cases <- fCleanData(datos = cases,  place = "bogota_d_c", type = "depto")

new_cases <-
    bog_cases %>% 
    group_by(fis) %>% 
    summarise(cases = sum(cases, na.rm = TRUE)) %>% rename(date = fis)

new_deaths <- 
    bog_cases %>% 
    group_by(fecha_de_muerte) %>% 
    summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
    rename(date = fecha_de_muerte) 

incidence <- merge(new_cases, new_deaths, by = "date", all = TRUE) %>% 
    filter(!is.na(date)) 
incidence$cases[is.na(incidence$cases)] <- 0
incidence$deaths[is.na(incidence$deaths)] <- 0
#incidence$X <- 1:NROW(incidence)
incidence <- incidence[1:(NROW(incidence)-14),]

### Rt_bogota
names(datos) <- epitrix::clean_labels(names(datos))

datos$fecha_diagnostico <- as.Date(as.numeric(datos$fecha_diagnostico),
                                   origin = "1900-01-01")
datos_inc <- datos %>%
    mutate(date = as.Date (fis),
           fecha_diagnostico=as.Date(fecha_diagnostico),
           type=case_when(tipo=="Importado"~"imported",
                          tipo=="Relacionado"~"local",
                          tipo=="En estudio"~"local"))

datos_inc$fis_clean <- clean_labels(datos_inc$fis)
datos_inc$asymptomatic <- 0
datos_inc$asymptomatic[datos_inc$fis_clean ==  "asintomatico"] <- 1

datos <- datos_inc %>% filter(asymptomatic == 0)

rezago <- 14
fechaConfiable <- as.Date(max(datos$fecha_de_notificacion),origin = "1900-01-01") - rezago

inc_multiple  <- incidence(datos$date, groups = datos$type)[1:(max(datos$date)-min(datos$date)- rezago)] 
days <- seq_along(inc_multiple$dates)[2:(length(inc_multiple$dates)-7)]
RTo  <- estimate_R(inc_multiple, method = "parametric_si",
                   config = make_config(list(
                       mean_si = 6.48, std_si = 3.83,
                       t_start=days, t_end=days+7)))

intervalo_serial <- as.vector(RTo$si_distr)

### CORRER LIBRERÍA "epidemia"
options(mc.cores=parallel::detectCores())# esta instrucción permite que se ejecuten cadenas en paralelo y no en secuencia

###### Bogotá
incidence_bog <- incidence%>% select(date,deaths)
inicio<-data.frame(date=c("2020-02-29","2020-03-02","2020-03-03"),
                    deaths=c(0, 0,0))
incidence_bog <- rbind(incidence_bog,inicio)
incidence_bog <-incidence_bog %>% arrange(date) 

eventos_publicos <- c(rep(0,14),rep(1,118))
colegios_publicos <- c(rep(0,18),rep(1,114))
cuerentena <- c(rep(0,22),rep(1,110))

incidence_bog <- cbind(incidence_bog,eventos_publicos,colegios_publicos,cuerentena)
obs_1 <- !is.na(incidence_bog$deaths)
si <- intervalo_serial
#si <- c(0.000, 0.233, 0.359, 0.198, 0.103, 0.053, 0.027, 0.014, 0.007, 0.003, 0.002, 0.001)

args_1 <- list(formula=Rt(country,date)~ 0 + rw(time=week,prior_scale=0.1),
             data=data.frame(country="bogota",
                             date=incidence_bog$date,
                             week=format(incidence_bog$date, "%V")),
             obs=list(
                 incidence=list(
                     odata=data.frame(country="bogota",
                                      date=incidence_bog$date[obs_1],incidence=incidence_bog$deaths[obs_1]),
                     rates=list(means=data.frame(factor("bogota"),1),
                                scale=.01),
                     pvec=c(.25,.25,.25,.25)
                 )
             ),
             seed_days=7,
             algorithm="sampling",
             r0=3,
             pops=data.frame(country="bogota",pop=8000000),
             si=si,
             prior = rstanarm::normal(location=0,scale=.2),
             prior_intercept = rstanarm::normal(location=0,scale=.5),
             prior_tau = rstanarm::exponential(rate=4)             
)
args_1$sampling_args_1 <- list(iter=500,control=list(adapt_delta=0.95,max_treedepth=15),seed=713)

fit_1 <- do.call("epim",args_1)



```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
grid.arrange(plot_obs(fit_1,type="incidence"), plot_infections(fit_1), plot_rt(fit_1),nrow=3)
```

## Simulación para Bogotá con intercepto y en relación con una caminata aleatoria

```{r, message=FALSE, echo=FALSE, warning=FALSE}

args_2 <- list(formula=Rt(country,date)~ 1 + rw(time=week,prior_scale=0.1),
             data=data.frame(country="bogota",
                             date=incidence_bog$date,
                             week=format(incidence_bog$date, "%V")),
             obs=list(
                 incidence=list(
                     odata=data.frame(country="bogota",
                                      date=incidence_bog$date[obs_1],incidence=incidence_bog$deaths[obs_1]),
                     rates=list(means=data.frame(factor("bogota"),1),
                                scale=.01),
                     pvec=c(.25,.25,.25,.25)
                 )
             ),
             seed_days=7,
             algorithm="sampling",
             r0=3,
             pops=data.frame(country="bogota",pop=8000000),
             si=si,
             prior = rstanarm::normal(location=0,scale=.2),
             prior_intercept = rstanarm::normal(location=0,scale=.5),
             prior_tau = rstanarm::exponential(rate=4)             
)
args_2$sampling_args_2 <- list(iter=500,control=list(adapt_delta=0.95,max_treedepth=15),seed=713)

fit_2 <- do.call("epim",args_2)

#grid.arrange(plot_obs(fit_2,type="incidence"), plot_infections(fit_2), plot_rt(fit_2),nrow=3)

```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
grid.arrange(plot_obs(fit_2,type="incidence"), plot_infections(fit_2), plot_rt(fit_2),nrow=3)
```


## Simulación para Bogotá considerando intervenciones

A continuación se realiza una simulación para Bogotá considerando intervenciones en universidades y escuelas, eventos públicos y cuarentenas.

```{r, message=FALSE, echo=FALSE, warning=FALSE}
args_3 <- list(formula=Rt(country,date)~ 0 + eventos_publicos+ colegios_publicos+
                   cuarentena,
               data=data.frame(country="bogota",
                               date=incidence_bog$date,
                               eventos_publicos = incidence_bog$eventos_publicos,
                               colegios_publicos = incidence_bog$colegios_publicos,
                               cuarentena = incidence_bog$cuerentena,
                               week=format(incidence_bog$date, "%V")),
               obs=list(
                   incidence=list(
                       odata=data.frame(country="bogota",
                                        date=incidence_bog$date[obs_1],incidence=incidence_bog$deaths[obs_1]),
                       rates=list(means=data.frame(factor("bogota"),1),
                                  scale=.01),
                       pvec=c(.25,.25,.25,.25)
                   )
               ),
               seed_days=7,
               algorithm="sampling",
               r0=3,
               pops=data.frame(country="bogota",pop=8000000),
               si=si,
               prior = rstanarm::normal(location=0,scale=.2),
               prior_intercept = rstanarm::normal(location=0,scale=.5),
               prior_tau = rstanarm::exponential(rate=4)             
)

args_3$sampling_args_3 <- list(iter=500,control=list(adapt_delta=0.95,max_treedepth=15),seed=713)

fit_3 <- do.call("epim",args_2)

```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
grid.arrange(plot_obs(fit_3,type="incidence"), plot_infections(fit_3), plot_rt(fit_3),nrow=3)

```